name: CD - Deploy Docker Image to EC2

on:
  workflow_dispatch:  # manual trigger only

jobs:
  deploy-to-ec2:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: SSH and deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EEC2_USER || 'ec2-user' }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "Logging in to ECR..."
            aws ecr get-login-password --region us-west-2 \
              | docker login --username AWS --password-stdin 065967698165.dkr.ecr.us-west-2.amazonaws.com

            echo "Pulling latest image..."
            docker pull 065967698165.dkr.ecr.us-west-2.amazonaws.com/varaha-web-services:latest

            echo "Stopping existing container (if any)..."
            if [ "$(docker ps -q -f name=varaha-web-services)" ]; then
              docker stop varaha-web-services
              docker rm varaha-web-services
            fi

            echo "Starting new container..."
            docker run -d \
              --name varaha-web-services \
              -p 8080:8080 \
              065967698165.dkr.ecr.us-west-2.amazonaws.com/varaha-web-services:latest

            echo "Deployment complete."
